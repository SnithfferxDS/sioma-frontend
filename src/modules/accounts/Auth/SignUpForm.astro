---
import Logo from '@Assets/img/app_logo.svg';
import { Image } from 'astro:assets';
import { APP_FULL_NAME, SITE_TITLE, APP_S_VERSION } from '@Configs/constants';
---

<div
    class="w-full flex flex-col items-center justify-center px-6 pt-10 mx-auto pt:mt-0"
>
    <a
        href="/"
        class="flex
        items-center
        justify-center
        mb-8
        text-2xl
        font-semibold
        lg:mb-10
        dark:text-white"
    >
        <Image src={Logo} alt={APP_FULL_NAME} class="h-8 md:h-14 lg:16" />
        <span class="sr-only">{SITE_TITLE} {APP_S_VERSION}</span>
    </a>
    <!-- Card -->
    <div
        class="w-full max-w-xl p-6 space-y-8 sm:p-8 bg-white rounded-lg shadow dark:bg-gray-800"
    >
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
            Crear Cuenta
        </h2>
        <form class="mt-8 space-y-6" method="POST" id="createForm">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label
                        for="person_name"
                        class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-200"
                    >
                        Nombres
                    </label>
                    <input
                        id="person_name"
                        name="person_name"
                        type="text"
                        required
                        class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="John"
                    />
                </div>
                <div>
                    <label
                        for="person_lastname"
                        class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-200"
                    >
                        Apellidos
                    </label>
                    <input
                        id="person_lastname"
                        name="person_lastname"
                        type="text"
                        required
                        class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                        placeholder="Doe"
                    />
                </div>
            </div>
            <div>
                <label
                    for="user_name"
                    class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-200"
                >
                    Nombre de usuario
                </label>
                <input
                    id="user_name"
                    name="user_name"
                    type="text"
                    autocomplete="user_name"
                    class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                    placeholder="johndoe"
                />
            </div>
            <div>
                <label
                    for="email"
                    class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                    >Su email</label
                >
                <input
                    type="email"
                    name="email"
                    id="email"
                    class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                    placeholder="johndoe@example.com"
                    required
                />
            </div>
            <div>
                <label
                    for="phone"
                    class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-200"
                >
                    Teléfono (opcional)
                </label>
                <input
                    id="phone"
                    name="phone"
                    type="tel"
                    class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                />
            </div>
            <div>
                <label
                    for="password"
                    class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                    >Su contraseña</label
                >
                <input
                    type="password"
                    name="password"
                    id="password"
                    placeholder="••••••••"
                    class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                    required
                />
            </div>
            <div class="flex items-start">
                <div class="flex items-center h-5">
                    <input
                        id="remember"
                        aria-describedby="remember"
                        name="remember"
                        type="checkbox"
                        class="w-4 h-4 border-gray-300 rounded bg-gray-50 focus:ring-3 focus:ring-primary-300 dark:focus:ring-primary-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
                        required
                    />
                </div>
                <div class="ml-3 text-sm">
                    <label
                        for="remember"
                        class="font-medium text-gray-900 dark:text-white"
                        >Acepto los <a
                            href="/legal/app-terms"
                            class="text-primary-500 hover:underline dark:text-primary-700"
                            >Terminos y Condiciones</a
                        ></label
                    >
                </div>
            </div>
            <div>
                <button
                    type="submit"
                    class="inline-flex
					mr-2
					justify-center
					rounded-md
					px-3
					py-1.5
					mb-3
					text-sm
					font-semibold
					leading-6
					shadow-sm
					focus-visible:outline
					focus-visible:outline-offset-2
					bg-indigo-500
					text-white
					hover:bg-indigo-600
					focus-visible:outline-indigo-500/80"
                >
                    Registrarse
                </button>
                <button
                    type="button"
                    id="btnMigrate"
                    class="inline-flex
					mr-2
					justify-center
					rounded-md
					px-3
					py-1.5
					mb-3
					text-sm
					font-semibold
					leading-6
					shadow-sm
					focus-visible:outline
					focus-visible:outline-offset-2
					bg-violet-500
					text-white
					hover:bg-violet-600
					focus-visible:outline-violet-500/80"
                    data-drawer-target="drawer-migrate-default"
                    data-drawer-show="drawer-migrate-default"
                    aria-controls="drawer-migrate-default"
                    data-drawer-placement="right">Migrar</button
                >
                <a
                    href="/"
                    class="inline-flex
					mr-2
					justify-center
					rounded-md
					px-3
					py-1.5
					mb-3
					text-sm
					font-semibold leading-6
					shadow-sm
					focus-visible:outline
					focus-visible:outline-offset-2
					text-center
					text-white
					bg-gray-700
					hover:bg-gray-800
					focus:ring-gray-300
					dark:bg-gray-600
					dark:hover:bg-gray-700
					dark:focus:ring-gray-800"
                >
                    cancelar
                </a>
            </div>
            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">
                Ya tienes una cuenta? <a
                    href="/auth/sign-in"
                    class="text-primary-500 hover:underline dark:text-primary-700"
                    >Iniciar Sesión</a
                >
                <a
                    href="/"
                    class="text-primary-500 hover:underline dark:text-primary-700"
                    >Volver a Inicio</a
                >
            </div>
        </form>
    </div>
</div>

<!-- Drawer for migration -->
<div
    id="drawer-migrate-default"
    class="fixed
				top-0
				right-0
				z-40
				w-full
				h-screen
				max-w-xs
				p-6
				overflow-y-auto
				transition-transform
				translate-x-full
				rounded-l-md
				bg-primary-800/50
				dark:bg-primary-700/50
				shadow-purple-500/50"
    tabindex="-1"
    aria-labelledby="drawer-label"
    aria-hidden="true"
>
    <h5
        id="drawer-label"
        class="inline-flex items-center mb-6 text-sm font-semibold text-gray-500 uppercase dark:text-gray-400"
    >
        Migrar usuario
    </h5>
    <button
        type="button"
        data-drawer-dismiss="drawer-migrate-default"
        aria-controls="drawer-migrate-default"
        class="text-gray-400 bg-transparent hover:bg-danger-200 hover:text-danger-900 rounded-lg text-sm p-1.5 absolute top-2.5 right-2.5 inline-flex items-center dark:hover:bg-danger-600 dark:hover:text-white"
    >
        <svg
            aria-hidden="true"
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path></svg
        >
    </button>
    <form id="migrateForm" class="max-w-lg rounded-lg shadow p-6">
        <div class="mb-4">
            <label
                for="user_migrate_name"
                class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-200"
            >
                Nombre de usuario
            </label>
            <input
                id="user_migrate_name"
                name="user_migrate_name"
                type="text"
                autocomplete="user_migrate_name"
                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 dark:bg-gray-700 dark:text-white dark:ring-gray-600"
            />
        </div>
        <div class="mb-4">
            <label
                for="user_migrate_password"
                class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-200"
            >
                Contraseña
            </label>
            <input
                id="user_migrate_password"
                name="user_migrate_password"
                type="password"
                autocomplete="new-password"
                required
                class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 dark:bg-gray-700 dark:text-white dark:ring-gray-600"
            />
        </div>
        <div class="flex justify-end space-x-4">
            <button
                type="submit"
                class="px-4 py-2 text-white bg-primary-700 rounded-md hover:bg-primary-500"
            >
                Migrar
            </button>
            <button
                type="button"
                data-drawer-dismiss="drawer-migrate-default"
                aria-controls="drawer-migrate-default"
                class="px-4 py-2 text-white bg-red-500 rounded-md hover:bg-red-600"
            >
                Cancelar
            </button>
        </div>
    </form>
</div>

<script>
    import { showSuccess, showError } from '@Lib/utils/notifications';
    import { validateUserAccount } from '@Lib/utils/validation';
    import { API_URL } from '@Configs/constants';

    const userNameInput = document.getElementById(
        'user_name'
    ) as HTMLInputElement;
    const btnMigrate = document.getElementById(
        'btnMigrate'
    ) as HTMLButtonElement;
    const migrateForm = document.getElementById(
        'migrateForm'
    ) as HTMLFormElement;

    const form = document.getElementById('createForm');
    form?.addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(form as HTMLFormElement);
        const data = {
            email: formData.get('email'),
            password: formData.get('password'),
            confirmPassword: formData.get('confirmPassword'),
            name: formData.get('person_name'),
            lastname: formData.get('person_lastname'),
            phone: formData.get('phone'),
            user: formData.get('user_name')
        };
        const validation = validateUserAccount(data);
        if (validation.errors) {
            showError(Object.values(validation.errors).flat().join('\n'));
            return;
        }
        try {
            const response = await fetch(`${API_URL}/auth`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showSuccess('¡Usuario creado con exito!');
                window.location.href = '/auth/login';
            } else {
                const error = await response.json();
                showError(
                    error.message ||
                        'No se ha podido crear el usuario, favor verificar información y volver a intentar'
                );
            }
        } catch (error) {
            showError('Error inesperado, favor verificar consola.');
            console.error(error);
        }
    });

    userNameInput?.addEventListener('input', async () => {
        const value = userNameInput.value;
        if (value) {
            if (value.length > 3) {
                const exists = await fetch(`${API_URL}/users/exists`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userName: value })
                }).catch(error => {
                    showError('Error inesperado, favor verificar consola.');
                    console.error(error);
                });
                if (exists) {
                    if (!exists.ok) {
                        btnMigrate.classList.remove('hidden');
                    }
                }
            }
        }
    });

    migrateForm?.addEventListener('submit', async e => {
        e.preventDefault();
        const formData = new FormData(migrateForm as HTMLFormElement);
        const data = {
            userName: formData.get('user_migrate_name'),
            password: formData.get('user_migrate_password')
        };
        try {
            const response = await fetch(`${API_URL}/users/migrate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showSuccess('¡Usuario migrado con exito!');
                window.location.href = '/auth/login';
            } else {
                const error = await response.json();
                showError(
                    error.message ||
                        'No se ha podido migrar el usuario, favor verificar información y volver a intentar'
                );
            }
        } catch (error) {
            showError('Error inesperado, favor verificar consola.');
            console.error(error);
        }
    });
</script>
